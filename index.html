<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1924 Mill Order Form</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .hidden {
            display: none;
        }
        /* Add some transition for smoother display */
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-6 bg-white shadow-lg rounded-lg my-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">1924 Mill Order Form</h1>

        <div id="messageArea" class="mb-4 p-3 text-sm rounded-md hidden" role="alert"></div>

        <div id="loginSection" class="fade-in">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Identify Yourself</h2>
            <div class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="loginEmail" name="loginEmail" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="loginBlockName" class="block text-sm font-medium text-gray-700">Block/Building Name</label>
                    <input type="text" id="loginBlockName" name="loginBlockName" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="loginDoorNumber" class="block text-sm font-medium text-gray-700">House Number</label>
                    <input type="text" id="loginDoorNumber" name="loginDoorNumber" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>
            <button id="validateBtn"
                    class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:shadow-outline transition duration-200">
                Continue
            </button>
        </div>

        <div id="securityQuestionSection" class="hidden fade-in">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Security Validation</h2>
            <div class="space-y-4">
                <div id="securityQuestionDisplay" class="text-lg font-medium text-gray-800"></div>
                <select id="securityQuestionSelect" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </select>
                <div>
                    <label for="securityAnswer" class="block text-sm font-medium text-gray-700">Your Answer</label>
                    <input type="text" id="securityAnswer" name="securityAnswer" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>
            <button id="answerQuestionBtn"
                    class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:shadow-outline transition duration-200">
                Submit Answer
            </button>
        </div>

        <form id="orderForm" class="hidden fade-in">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Your Order Details</h2>
            <div class="space-y-4">
                <input type="hidden" id="customerEmail" name="customerEmail">
                <input type="hidden" id="customerName" name="customerName">
                <input type="hidden" id="customerContact" name="customerContact">
                <input type="hidden" id="blockName" name="blockName">
                <input type="hidden" id="doorNumber" name="doorNumber">

                <div>
                    <label for="purchaseDate" class="block text-sm font-medium text-gray-700">Order Date</label>
                    <input type="text" id="purchaseDate" name="purchaseDate" readonly
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 sm:text-sm">
                </div>

                <div id="productsList">
                    <h3 class="text-xl font-semibold text-gray-700 my-4">Select Products</h3>

                    <div class="product-item flex items-center justify-between mb-4 p-3 border rounded-md shadow-sm">
                        <img src="https://via.placeholder.com/80x80?text=Atta" alt="Sharbati Atta" class="w-20 h-20 object-cover mr-4">
                        <label for="sharbatiAttaQuantity" class="flex-grow">Sharbati Atta - Stone Ground (Rs 100/kg)</label>
                        <input type="number" id="sharbatiAttaQuantity" data-price="100" min="0" value="0" class="product-quantity w-20 text-center p-2 border border-gray-300 rounded-md">
                        <span class="text-sm text-gray-600 ml-2">Kgs</span>
                        <span class="price-display ml-4 font-semibold text-gray-800">₹<span id="sharbatiAttaTotal">0</span></span>
                    </div>

                    <div class="product-item flex items-center justify-between mb-4 p-3 border rounded-md shadow-sm">
                        <img src="https://via.placeholder.com/80x80?text=Ragi" alt="Ragi Powder" class="w-20 h-20 object-cover mr-4">
                        <label for="ragiPowderQuantity" class="flex-grow">Ragi Powder (Rs 120/kg)</label>
                        <input type="number" id="ragiPowderQuantity" data-price="120" min="0" value="0" class="product-quantity w-20 text-center p-2 border border-gray-300 rounded-md">
                        <span class="text-sm text-gray-600 ml-2">Kgs</span>
                        <span class="price-display ml-4 font-semibold text-gray-800">₹<span id="ragiPowderTotal">0</span></span>
                    </div>

                    <div class="product-item flex items-center justify-between mb-4 p-3 border rounded-md shadow-sm">
                        <img src="https://via.placeholder.com/80x80?text=Jowar" alt="Jowar Powder" class="w-20 h-20 object-cover mr-4">
                        <label for="jowarPowderQuantity" class="flex-grow">Jowar Powder (Rs 90/kg)</label>
                        <input type="number" id="jowarPowderQuantity" data-price="90" min="0" value="0" class="product-quantity w-20 text-center p-2 border border-gray-300 rounded-md">
                        <span class="text-sm text-gray-600 ml-2">Kgs</span>
                        <span class="price-display ml-4 font-semibold text-gray-800">₹<span id="jowarPowderTotal">0</span></span>
                    </div>

                    <div class="product-item flex items-center justify-between mb-4 p-3 border rounded-md shadow-sm">
                        <img src="https://via.placeholder.com/80x80?text=Bajra" alt="Bajra Powder" class="w-20 h-20 object-cover mr-4">
                        <label for="bajraPowderQuantity" class="flex-grow">Bajra Powder (Rs 80/kg)</label>
                        <input type="number" id="bajraPowderQuantity" data-price="80" min="0" value="0" class="product-quantity w-20 text-center p-2 border border-gray-300 rounded-md">
                        <span class="text-sm text-gray-600 ml-2">Kgs</span>
                        <span class="price-display ml-4 font-semibold text-gray-800">₹<span id="bajraPowderTotal">0</span></span>
                    </div>

                    <div class="product-item flex items-center justify-between mb-4 p-3 border rounded-md shadow-sm">
                        <img src="https://via.placeholder.com/80x80?text=Rice" alt="Rice Powder" class="w-20 h-20 object-cover mr-4">
                        <label for="ricePowderQuantity" class="flex-grow">Rice Powder (Rs 70/kg)</label>
                        <input type="number" id="ricePowderQuantity" data-price="70" min="0" value="0" class="product-quantity w-20 text-center p-2 border border-gray-300 rounded-md">
                        <span class="text-sm text-gray-600 ml-2">Kgs</span>
                        <span class="price-display ml-4 font-semibold text-gray-800">₹<span id="ricePowderTotal">0</span></span>
                    </div>

                    <div class="product-item flex items-center justify-between mb-4 p-3 border rounded-md shadow-sm">
                        <img src="https://via.placeholder.com/80x80?text=Coconut" alt="Coconut Oil" class="w-20 h-20 object-cover mr-4">
                        <label for="coconutOilQuantity" class="flex-grow">Coconut Oil (Rs 250/litre)</label>
                        <input type="number" id="coconutOilQuantity" data-price="250" min="0" value="0" class="product-quantity w-20 text-center p-2 border border-gray-300 rounded-md">
                        <span class="text-sm text-gray-600 ml-2">Litres</span>
                        <span class="price-display ml-4 font-semibold text-gray-800">₹<span id="coconutOilTotal">0</span></span>
                    </div>

                    <div class="product-item flex items-center justify-between mb-4 p-3 border rounded-md shadow-sm">
                        <img src="https://via.placeholder.com/80x80?text=Gingelly" alt="Gingelly Oil" class="w-20 h-20 object-cover mr-4">
                        <label for="gingellyOilQuantity" class="flex-grow">Gingelly Oil (Rs 300/litre)</label>
                        <input type="number" id="gingellyOilQuantity" data-price="300" min="0" value="0" class="product-quantity w-20 text-center p-2 border border-gray-300 rounded-md">
                        <span class="text-sm text-gray-600 ml-2">Litres</span>
                        <span class="price-display ml-4 font-semibold text-gray-800">₹<span id="gingellyOilTotal">0</span></span>
                    </div>
                </div>

                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-md">
                    <span class="text-lg font-bold text-gray-800">Grand Total:</span>
                    <span class="text-2xl font-extrabold text-green-600">₹<span id="grandTotal">0</span></span>
                </div>

                <div class="mt-6 p-4 border border-blue-200 rounded-md bg-blue-50">
                    <h3 class="text-xl font-semibold text-blue-800 mb-3">Subscription Options</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="deliveryFrequency" class="block text-sm font-medium text-gray-700">Delivery Frequency (Optional)</label>
                            <select id="deliveryFrequency" name="deliveryFrequency"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="">One-time order</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Bi-Weekly">Bi-Weekly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>
                        <div>
                            <label for="orderNotes" class="block text-sm font-medium text-gray-700">Order Notes (Optional)</label>
                            <textarea id="orderNotes" name="orderNotes" rows="3"
                                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                        </div>
                    </div>
                </div>

            </div>

            <button type="submit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:shadow-outline transition duration-200 mt-6">
                Place Order
            </button>
        </form>
    </div>

    <script>
        // *** IMPORTANT: REPLACE THIS WITH YOUR APPS SCRIPT WEB APP URL ***
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyzvVErdzOoKzCLrI8yuzj_dA4VPVO1yI5Hiw8lmWDdM-sCSBevFdzsYLdA66LhDJagqg/exec';

        // DOM Elements
        const messageArea = document.getElementById('messageArea');
        const loginSection = document.getElementById('loginSection');
        const validateBtn = document.getElementById('validateBtn');

        const securityQuestionSection = document.getElementById('securityQuestionSection');
        const securityQuestionDisplay = document.getElementById('securityQuestionDisplay');
        const securityQuestionSelect = document.getElementById('securityQuestionSelect');
        const securityAnswerInput = document.getElementById('securityAnswer');
        const answerQuestionBtn = document.getElementById('answerQuestionBtn');

        const orderFormSection = document.getElementById('orderForm'); // This is the form itself

        // Hidden fields in the order form to carry validated user data
        const customerEmailHidden = document.getElementById('customerEmail');
        const customerNameHidden = document.getElementById('customerName'); // Will store the email as "Name" for now
        const customerContactHidden = document.getElementById('customerContact'); // Will store the email as "Contact" for now
        const blockNameHidden = document.getElementById('blockName');
        const doorNumberHidden = document.getElementById('doorNumber');

        // Store validated user data temporarily in session storage
        // This allows refreshing the page without re-validating within the same session
        let validatedUserData = JSON.parse(sessionStorage.getItem('validatedUserData')) || {};
        let currentMemberId = sessionStorage.getItem('currentMemberId') || '';


        // --- Utility Functions ---
        function showMessage(type, message) {
            messageArea.textContent = message;
            messageArea.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-700');
            } else { // info or warning
                messageArea.classList.add('bg-blue-100', 'text-blue-700');
            }
            messageArea.classList.remove('hidden');
            messageArea.scrollIntoView({ behavior: 'smooth' }); // Scroll to message
        }

        function hideMessage() {
            messageArea.classList.add('hidden');
        }

        function showSection(sectionElement) {
            loginSection.classList.add('hidden');
            securityQuestionSection.classList.add('hidden');
            orderFormSection.classList.add('hidden');
            sectionElement.classList.remove('hidden');
        }

        // --- SHA-256 Hashing (Client-Side) ---
        async function sha256(message) {
            const textEncoder = new TextEncoder();
            const data = textEncoder.encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hexHash;
        }

        // --- Form Initialization and Product Calculation ---
        document.addEventListener('DOMContentLoaded', () => {
            const purchaseDateInput = document.getElementById('purchaseDate');
            const now = new Date();
            const options = {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                timeZoneName: 'short', timeZone: 'Asia/Kolkata'
            };
            purchaseDateInput.value = now.toLocaleString('en-IN', options);

            const productQuantities = document.querySelectorAll('.product-quantity');
            const grandTotalSpan = document.getElementById('grandTotal');

            function calculateTotal() {
                let grandTotal = 0;
                productQuantities.forEach(input => {
                    const quantity = parseFloat(input.value) || 0;
                    const price = parseFloat(input.dataset.price);
                    const productTotal = quantity * price;
                    document.getElementById(input.id.replace('Quantity', 'Total')).textContent = productTotal.toFixed(0);
                    grandTotal += productTotal;
                });
                grandTotalSpan.textContent = grandTotal.toFixed(0);
            }

            productQuantities.forEach(input => {
                input.addEventListener('input', calculateTotal);
                input.addEventListener('blur', calculateTotal);
            });

            calculateTotal(); // Initial calculation

            // Check for existing validated session on page load
            if (currentMemberId && validatedUserData.email && validatedUserData.blockName && validatedUserData.houseNumber) {
                customerEmailHidden.value = validatedUserData.email;
                customerNameHidden.value = validatedUserData.email;
                customerContactHidden.value = validatedUserData.email;
                blockNameHidden.value = validatedUserData.blockName;
                doorNumberHidden.value = validatedUserData.houseNumber;
                showSection(orderFormSection);
                showMessage('info', 'Welcome back! You are logged in.');
            } else {
                showSection(loginSection); // Show login if not already validated
            }
        });


        // --- Login/Validation Logic ---
        validateBtn.addEventListener('click', async () => {
            hideMessage();
            const email = document.getElementById('loginEmail').value.trim();
            const blockName = document.getElementById('loginBlockName').value.trim();
            const houseNumber = document.getElementById('loginDoorNumber').value.trim();
            securityAnswerInput.value = ''; // Clear answer field

            if (!email || !blockName || !houseNumber) {
                showMessage('error', 'Please fill in all identification fields.');
                return;
            }

            // Store for later use in this session
            validatedUserData = { email, blockName, houseNumber };
            sessionStorage.setItem('validatedUserData', JSON.stringify(validatedUserData));


            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'validate_user',
                        email,
                        blockName,
                        houseNumber
                    }),
                });

                const data = await response.json();
                } catch (error) {
                // This is the block that prints "TypeError: Failed to fetch"
                console.error('Validation fetch error:', error);
                showMessage('error', 'Could not connect to validation service. Please try again later.');
            }

                if (data.status === 'success') {
                    showMessage('success', data.message);
                    currentMemberId = data.memberId;
                    sessionStorage.setItem('currentMemberId', currentMemberId);

                    // Populate hidden fields in the order form
                    customerEmailHidden.value = validatedUserData.email;
                    customerNameHidden.value = validatedUserData.email; // Using email as name for now
                    customerContactHidden.value = validatedUserData.email; // Using email as contact for now
                    blockNameHidden.value = validatedUserData.blockName;
                    doorNumberHidden.value = validatedUserData.houseNumber;

                    // User is validated, show order form
                    showSection(orderFormSection);
                } else if (data.status === 'new_user_prompt_question' || data.status === 'set_new_question') {
                    showMessage('info', data.message);
                    currentMemberId = data.memberId;
                    sessionStorage.setItem('currentMemberId', currentMemberId);

                    securityQuestionDisplay.classList.add('hidden'); // Hide specific question display
                    securityQuestionSelect.classList.remove('hidden'); // Show dropdown for selection

                    // Populate dropdown with questions
                    securityQuestionSelect.innerHTML = '<option value="">-- Select a question --</option>';
                    data.questions.forEach((q, index) => {
                        const option = document.createElement('option');
                        option.value = q;
                        option.textContent = q;
                        securityQuestionSelect.appendChild(option);
                    });
                    showSection(securityQuestionSection);
                } else if (data.status === 'ask_question') {
                    showMessage('info', data.message);
                    currentMemberId = data.memberId;
                    sessionStorage.setItem('currentMemberId', currentMemberId);

                    securityQuestionDisplay.textContent = data.question;
                    securityQuestionDisplay.classList.remove('hidden'); // Show specific question display
                    securityQuestionSelect.classList.add('hidden'); // Hide dropdown for selection

                    showSection(securityQuestionSection);
                } else if (data.status === 'incorrect_answer') {
                    showMessage('error', data.message);
                    // Re-display the question if they got it wrong
                    securityQuestionDisplay.textContent = data.question;
                    securityQuestionDisplay.classList.remove('hidden');
                    securityQuestionSelect.classList.add('hidden');
                    showSection(securityQuestionSection); // Stay on question section
                } else {
                    showMessage('error', data.message || 'An unknown error occurred during validation.');
                }

            } catch (error) {
                console.error('Validation fetch error:', error);
                showMessage('error', 'Could not connect to validation service. Please try again later.');
            }
        });

        // --- Security Question Answer Submission Logic ---
        answerQuestionBtn.addEventListener('click', async () => {
            hideMessage();
            // Ensure we have the user data from the initial validation step
            if (!validatedUserData.email || !validatedUserData.blockName || !validatedUserData.houseNumber) {
                showMessage('error', 'User data missing. Please re-enter your details.');
                showSection(loginSection); // Go back to login
                return;
            }

            let selectedQuestion = securityQuestionDisplay.textContent; // For existing users being asked a specific question
            if (!securityQuestionSelect.classList.contains('hidden')) {
                // For new users choosing a question, or existing users setting one for the first time
                selectedQuestion = securityQuestionSelect.value;
            }
            const answer = securityAnswerInput.value.trim();

            if (!selectedQuestion || !answer) {
                showMessage('error', 'Please select a question and provide an answer.');
                return;
            }

            // Hash the answer before sending
            const hashedAnswer = await sha256(answer);

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'register_question', // This action handles both setting and validating
                        email: validatedUserData.email,
                        blockName: validatedUserData.blockName,
                        houseNumber: validatedUserData.houseNumber,
                        securityQuestion: selectedQuestion,
                        securityAnswerHash: hashedAnswer // Send the hash to Apps Script
                    }),
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showMessage('success', data.message);
                    currentMemberId = data.memberId;
                    sessionStorage.setItem('currentMemberId', currentMemberId);

                    // Populate hidden fields for the order form
                    customerEmailHidden.value = validatedUserData.email;
                    customerNameHidden.value = validatedUserData.email;
                    customerContactHidden.value = validatedUserData.email;
                    blockNameHidden.value = validatedUserData.blockName;
                    doorNumberHidden.value = validatedUserData.houseNumber;

                    showSection(orderFormSection);
                } else {
                    showMessage('error', data.message || 'An error occurred while submitting your answer. Please try again.');
                    securityAnswerInput.value = ''; // Clear answer field for retry
                }

            } catch (error) {
                console.error('Answer submission fetch error:', error);
                showMessage('error', 'Could not connect to verification service. Please try again later.');
            }
        });


        // --- Order Submission Logic (Modified) ---
        orderFormSection.addEventListener('submit', async function(event) {
            event.preventDefault();

            hideMessage(); // Clear previous messages

            // Basic validation for products
            let anyProductSelected = false;
            document.querySelectorAll('.product-quantity').forEach(input => {
                if (parseFloat(input.value) > 0) {
                    anyProductSelected = true;
                }
            });

            if (!anyProductSelected) {
                showMessage('error', 'Please select at least one product to place an order.');
                return;
            }

            // Collect order details from the form
            const purchaseDate = document.getElementById('purchaseDate').value;
            const orderNotes = document.getElementById('orderNotes').value;
            const deliveryFrequency = document.getElementById('deliveryFrequency').value;

            let orderDetails = []; // For email body
            let productsData = {}; // For Google Sheet

            document.querySelectorAll('.product-quantity').forEach(input => {
                const quantity = parseFloat(input.value) || 0;
                productsData[input.id] = quantity; // Store with original ID

                if (quantity > 0) {
                    const labelElement = document.querySelector(`label[for="${input.id}"]`);
                    let productName = labelElement ? labelElement.textContent.split('(')[0].trim() : input.id.replace('Quantity', '').replace(/([A-Z])/g, ' $1').trim();
                    const pricePerUnit = parseFloat(input.dataset.price);
                    const productTotal = quantity * pricePerUnit;
                    let unitType = productName.includes('Oil') ? 'Litres' : 'Kgs';
                    let productString = `${productName}: ${quantity} ${unitType} @ ₹${pricePerUnit}/unit = ₹${productTotal.toFixed(0)}`;
                    orderDetails.push(productString);
                }
            });
            const grandTotal = document.getElementById('grandTotal').textContent;

            // Prepare data for Google Apps Script
            const formData = {
                action: 'submit_order', // New action for Apps Script
                CustomerEmail: customerEmailHidden.value,
                PurchaseDate: purchaseDate,
                CustomerName: customerNameHidden.value, // This is currenty the email from validation.
                CustomerContact: customerContactHidden.value, // This is currently the email from validation.
                BlockName: blockNameHidden.value,
                DoorNumber: doorNumberHidden.value,
                OrderNotes: orderNotes,
                DeliveryFrequency: deliveryFrequency,
                GrandTotal: grandTotal,
                OrderDetails: orderDetails // For email body
            };

            // Add product quantities to formData, converting client-side IDs to sheet headers
            for (const key in productsData) {
                const sheetHeaderKey = key.charAt(0).toUpperCase() + key.slice(1);
                formData[sheetHeaderKey] = productsData[key];
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showMessage('success', data.message + " You will receive a confirmation email shortly.");
                    orderFormSection.reset(); // Clear the order form
                    calculateTotal(); // Reset totals

                    // Clear session storage and go back to login screen
                    sessionStorage.removeItem('validatedUserData');
                    sessionStorage.removeItem('currentMemberId');
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginBlockName').value = '';
                    document.getElementById('loginDoorNumber').value = '';
                    document.getElementById('securityAnswer').value = '';
                    showSection(loginSection);

                    // Optional: Trigger WhatsApp message if still desired (user-initiated)
                    const whatsappNumber = "919980988114"; // Archana's WhatsApp number
                    let whatsappMessage = `*1924 Mill Order Details - Confirmation*\n\n` +
                                          `*Customer Details:*\n` +
                                          `Name: ${customerNameHidden.value}\n` +
                                          `Contact: ${customerContactHidden.value}\n` +
                                          `Address: ${blockNameHidden.value}, ${doorNumberHidden.value}\n\n` +
                                          `*Products Ordered:*\n`;
                    if (orderDetails.length > 0) {
                        whatsappMessage += orderDetails.join('\n') + '\n\n';
                    } else {
                        whatsappMessage += 'No products selected.\n\n';
                    }
                    whatsappMessage += `*Grand Total: ₹${grandTotal}*\n\n` +
                                       `_Thank you for your order with 1924 Mill! You will also receive an email confirmation._`;

                    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(whatsappMessage)}`;
                    window.open(whatsappUrl, '_blank');

                } else {
                    showMessage('error', data.message || 'An error occurred during order submission. Please try again.');
                }

            } catch (error) {
                console.error('Order submission fetch error:', error);
                showMessage('error', 'Could not submit order. Please check your internet connection or try again later.');
            }
        });

    </script>
</body>
</html>
